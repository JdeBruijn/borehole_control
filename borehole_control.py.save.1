import RPi.GPIO as gpio
import time
import subprocess

gpio.setmode(gpio.BOARD)

flow_switch=12
pump=11
float_switch=7

gpio.setup(flow_switch, gpio.IN, pull_up_down=gpio.PUD_DOWN)
gpio.setup(pump, gpio.OUT)
gpio.setup(float_switch, gpio.IN, pull_up_down=gpio.PUD_DOWN)
gpio.add_event_detect(float_switch,gpio.FALLING)

start_time=0
stop_time=0
time.time()

while(True):
	bash_date="date +%d-%m-%y_%H-%M-%

	if not gpio.input(float_switch):
		log = open("/home/jannie/borehole_log.txt", "a")
		log.write("Main Tank Full\n\n")
		log.close()
#		print("Main tank full")
		gpio.wait_for_edge(float_switch, gpio.RISING)

	gpio.output(pump, True)
	start_time=time.time()
	log = open("/home/jannie/borehole_log.txt", "a")
	
	pump_time = subprocess.check_output(bash_date.split())[:-1];
	
	log.write("Start pumping at "+pump_time+"\n")
	log.close()
#	print("Pumping")
	time.sleep(10)
	
	if(gpio.input(flow_switch)):
		gpio.wait_for_edge(flow_switch, gpio.FALLING)
	
	time.sleep(2)

	while(gpio.input(flow_switch)):
		time.sleep(2)

	gpio.output(pump, False)
	stop_time=time.time()
	log = open("/home/jannie/borehole_log.txt", "a")
	log.write(" pumped for "+str(round(stop_time-start_time))+" seconds\n\n")
	log.close()
#	print("Stopped pumping")
	
	time.sleep(600)
